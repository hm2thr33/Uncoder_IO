name: Build and Push Docker Images to AWS ECR

on:
  push:
    branches:
      - main

jobs:
  build_and_push:
    timeout-minutes: 2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      
      - name: Login to Amazon ECR
        id: login-ecr
        run: |
          echo ${{ secrets.AWS_ACCESS_KEY_ID }} > aws_access_key_id
          echo ${{ secrets.AWS_SECRET_ACCESS_KEY }} > aws_secret_access_key
          aws configure set aws_access_key_id "$(cat aws_access_key_id)"
          aws configure set aws_secret_access_key "$(cat aws_secret_access_key)"
          aws configure set default.region ${{ vars.AWS_DEFAULT_REGION }}
          aws ecr get-login-password --region ${{ vars.AWS_DEFAULT_REGION }} | docker login --username AWS --password-stdin ${{ vars.ECR_REPO }}
        
      - name: Build and Push Docker images
        run: |
          docker build -t ${{ vars.ECR_REPO }}/translator translator/
          docker push ${{ vars.ECR_REPO }}/translator.${{ github.sha }}

          docker build -t ${{ vars.ECR_REPO }}/uncoder-os uncoder-os/
          docker push ${{ vars.ECR_REPO }}/uncoder-os.${{ github.sha }}
